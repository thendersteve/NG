if(typeof(ngutils)=='undefined'){var ngutils={};ngutils.blacked_out=false;ngutils.debugAlert=function(msg){if(PHP.get('ngutils_debug',false))alert(msg);};(function($){var www_root=PHP.get('www_root','/');var referrer=PHP.get('referrer',www_root);var login_container,notification_bar,notification_shim;var is_mobile=PHP.get('ismobile')?true:false;ngutils.input={lastX:null,lastY:null,getMouse:function(e){var input=is_mobile?e.originalEvent.touches[0]:e;if(!input){return{x:this.lastX,y:this.lastY}}
this.lastX=input.pageX;this.lastY=input.pageY;return{x:input.pageX,y:input.pageY};}};if(is_mobile){ngutils.input.mouseDown="touchstart";ngutils.input.mouseUp="touchend";ngutils.input.mouseMove="touchmove";}else{ngutils.input.mouseDown="mousedown";ngutils.input.mouseUp="mouseup";ngutils.input.mouseMove="mousemove";}
$(function(){login_container=$('#user_login_container');notification_bar=$('#notification-bar');notification_shim=$('#notification-shim');ngutils.media.smartscale.autodetect();ngutils.condenseElements();ngutils.initScrollFixColumn();ngutils.ieHacks();ngutils.grids.init();ngutils.media.smartload.autodetect();ngutils.forms.fakeSelect.autodetect();ngutils.forms.selectLinks.autodetect();var noscroll=function(e){if(ngutils.screen_lock){e.preventDefault();return false;}
return true;};$('#body-main').on('touchmove',noscroll);$('#notification-bar').on('touchmove',noscroll);});$(document).ajaxComplete(function(){ngutils.media.smartscale.autodetect();ngutils.condenseElements();ngutils.media.smartload.autodetect();ngutils.forms.fakeSelect.autodetect();ngutils.forms.selectLinks.autodetect();});ngutils.screen_lock=false;ngutils.event={resize:'resize',closeall:'closeall',listeners:[],addListener:function(event,listener){if(typeof(ngutils.event.listeners[event])=='undefined')ngutils.event.listeners[event]=[];ngutils.event.listeners[event].unshift(listener);},removeListener:function(event,listener){if(typeof(ngutils.event.listeners[event])=='undefined')return;var index=ngutils.event.listeners[event].indexOf(listener);if(index>=0)ngutils.event.listeners[event].splice(index,1);},removeAll:function(event){if(typeof(ngutils.event.listeners[event])=='undefined')return;ngutils.event.listeners[event]=[];},dispatch:function(event,data){if(typeof(ngutils.event.listeners[event])=='undefined')return;for(var i=0;i<ngutils.event.listeners[event].length;i++){if(ngutils.event.listeners[event][i](data)===false)return;}}};$(function(){$(window).resize(function(){ngutils.event.dispatch(ngutils.event.resize);});var selector=is_mobile?'#body-main':'body';$(selector).click(function(){ngutils.event.dispatch(ngutils.event.closeall);});});ngutils.search={initMobile:function(element_id,shim_id,button_id,transition_speed,auto_open){var waiting=false;var open=auto_open?true:false;var element=$('#'+element_id);var shim=$('#'+shim_id);var button=$('#'+button_id);var textfield=element.find('input').first();element.show();var eheight=element.outerHeight();if(open){element.css('top',shim.outerHeight());}else{element.hide();}
button.click(function(){if(waiting)return false;ngutils.event.dispatch(ngutils.event.closeall,'topsearch');var nheight=shim.outerHeight();var anchor=nheight- eheight;waiting=true;var from=open?nheight:anchor;var to=open?anchor:nheight;open=!open;element.css('top',from);element.show();if(open)textfield.focus();element.animate({top:to},transition_speed,function(){waiting=false;if(!open)element.hide();});return false;});ngutils.event.addListener(ngutils.event.resize,function(){if(open){element.stop();var nheight=shim.outerHeight();element.css('top',nheight);}});ngutils.event.addListener(ngutils.event.closeall,function(source){ngutils.screen_lock=false;if(source!='topsearch'&&open){element.stop();var nheight=shim.outerHeight();var anchor=nheight- eheight;open=false;waiting=true;element.animate({top:anchor},transition_speed,function(){waiting=false;element.hide();});}});}};ngutils.desktop={register_menu:function(menu_id){var menu=$('#'+menu_id);$('button',menu).click(function(){var li=$(this).parent();if(li.hasClass('collapsed')){li.removeClass('collapsed');li.addClass('expanded');$(this).html("&ndash;");}else{li.removeClass('expanded');li.addClass('collapsed');$(this).html("+");}
return false;});}};ngutils.mobile={last_id:0};ngutils.mobile.menuController=function(container_id,button_id,default_menu){var i;var controller=this;this.id=ngutils.mobile.last_id;ngutils.mobile.last_id++;this.container=$("#"+container_id);this.button=$("#"+button_id);var waiting=false;var open=false;this.container.show();this.width=this.container.outerWidth();this.direction=this.container.hasClass('right-menu')?1:-1;this.background=$('div.mobile-menu-background',this.container).first();this.anchor=this.width*this.direction;this.background.css('left',this.anchor);this.container.hide();this.transition_speed=250;this.menus={};this.default_menu=null;this.current=null;this.width=this.container.outerWidth();var touchat=null;var startPos=null;var sceolling=false;var noscroll=function(e){var touchpos=e.originalEvent.touches[0].clientY;var maxScroll=controller.current.$element.prop('scrollHeight')- controller.container.innerHeight();if(maxScroll<1){e.preventDefault();return false;}
var moved=touchpos- touchat;touchat=touchpos;var scrollTop=controller.current.$element.scrollTop();if(scrollTop!=startPos&&!scrolling)scrolling=true;if((moved>0&&scrollTop<1)||(moved<0&&scrollTop>=maxScroll)){if(!scrolling){e.preventDefault();return false;}}
return true;};this.container.on('touchmove',noscroll);this.container.on('touchstart',function(e){touchat=e.originalEvent.touches[0].clientY;startPos=controller.current.$element.scrollTop();scrolling=false;});if(typeof(_params)=='object'){for(i in _params){this[i]=_params[i];}}
$("*[data-menu-id]",this.container).each(function(){var menu=new ngutils.mobile.menu($(this),controller);if(default_menu){if(menu.id==default_menu)controller.default_menu=menu;}else if(menu.isRoot()){controller.default_menu=menu;}
controller.menus[menu.id]=menu;});this.setMenu=function(menu_id,animate,direction){if(animate&&waiting)return false;if(!direction)direction=1;var menu=this.menus[menu_id];var to,from,anchor=0;if(this.current){anchor=this.anchor*direction;if(animate===true){waiting=true;var $last=this.current.$element;to=anchor;this.current.$element.animate({left:to},this.transition_speed,function(){waiting=false;$last.hide();});}else{this.current.$element.hide();}}
this.current=menu;if(!menu)return;this.current.$element.show();this.current.$element.scrollTop(0);if(animate===true){from=anchor*-1;to=0;waiting=true;this.current.$element.css('left',from);this.current.$element.animate({left:to},this.transition_speed,function(){waiting=false;});}else{this.current.$element.css('left',0);}};this.button.click(function(){if(waiting)return false;ngutils.event.dispatch(ngutils.event.closeall,'menuController'+controller.id);waiting=true;var from=open?0:controller.anchor;var to=open?controller.anchor:0;open=!open;if(open)controller.setMenu(controller.default_menu.id,false);controller.background.css('left',from);controller.container.show();controller.background.animate({left:to},controller.transition_speed,function(){waiting=false;if(!open){controller.container.hide();}else{ngutils.screen_lock=true;}});return false;});ngutils.event.addListener(ngutils.event.closeall,function(source){if(open&&source!=='menuController'+controller.id){controller.background.stop();var to=controller.anchor;waiting=true;open=false;controller.background.animate({left:to},controller.transition_speed,function(){waiting=false;controller.container.hide();});}});};ngutils.mobile.menu=function($element,controller){this.controller=controller;this.$element=$element;this.id=$element.attr('data-menu-id');this.parent_id=$element.attr('data-parent-id');this.parent=null;this.$element.hide();$("*[data-open-menu]").each(function(){var opens=$(this).attr('data-open-menu');var dir=$(this).attr('data-direction')=='-1'?-1:1;$(this).click(function(){controller.setMenu(opens,true,dir);return false;});});};ngutils.mobile.menu.prototype={children:[],addChild:function(child){this.children.push(child);},isRoot:function(){return!(this.parent_id&&this.parent_id!=this.id);}};ngutils.footer={buttons:[],selected:null,init:function(button_id_array){this.buttons=button_id_array;var $container=$('#footer-feature-buttons');$('button',$container).click(function(){ngutils.footer.changeTo($(this).attr('id'));return false;});$('#featureshift-left').click(function(){ngutils.footer.previous();return false;});$('#featureshift-right').click(function(){ngutils.footer.next();return false;});this.selected=$('button.selected',$container).first().attr('id');},changeTo:function(button_id){var $container=$('#footer-feature-buttons');var $items=$('#footer-featured-items');var $button=$("#"+button_id,$container);if(!$button)return;$('button.selected',$container).removeClass('selected');$button.addClass('selected');this.selected=button_id;var footer_feature=button_id.split("-").pop();$.get("/footer-feature/"+footer_feature,function(data){$items.html(data);});},next:function(){var index=this.buttons.indexOf(this.selected);index++;if(index>=this.buttons.length)index=0;this.changeTo(this.buttons[index]);},previous:function(){var index=this.buttons.indexOf(this.selected);index--;if(index<0)index=this.buttons.length- 1;this.changeTo(this.buttons[index]);}};ngutils.ieHacks=function(){var ua=window.navigator.userAgent;var msie=ua.indexOf("MSIE ");if(msie>0||!!navigator.userAgent.match(/Trident.*rv\:11\./))
{var outer=$('#outer-skin');function fixOuter(){$(outer).height($(document).height());}
ngutils.event.addListener(ngutils.event.resize,fixOuter);fixOuter();}};ngutils.fixTopMargin=function(){if(notification_shim&&notification_bar)notification_shim.height(notification_bar.outerHeight());};ngutils.grids={_initialized:false,init:function(){this.update();if(!this._initialized)ngutils.event.addListener(ngutils.event.resize,this.update);this._initialized=true;},init_grids_with_max_rows:function(){$("*[data-max-rows]").each(function(){var $grid=$(this);var max_rows=parseInt($grid.attr('data-max-rows'));ngutils.grids.setMaxRows($grid,max_rows);});},update:function(){ngutils.grids.init_grids_with_max_rows();},setMaxRows:function($grid,max_rows){var left=-9999;var row=1;$grid.children().each(function(){$(this).show();var l=$(this).offset().left;if(l<=left){row++;}
left=l;if(row>max_rows)$(this).hide();});}};ngutils.condenseElements=function(){$('.condensed').each(function(){ngutils.condenseElement($(this));});};ngutils.condenseElement=function(element){var $condensed=typeof(element)=='string'?$("#"+element):element;if(!$condensed)return;var $parent=$condensed.parent();var position=$parent.css('position').toLowerCase();if(position!='fixed'&&position!='absolute'&&position!='relative'){$parent.css('position','relative');}
var max_height=parseInt($condensed.css('max-height').replace(/[^-\d\.]/g,''));$condensed.removeClass('condensed');$condensed.css('max-height',"100%");if(isNaN(max_height)||max_height<1)return;var full_height=$condensed.height();var height_allowance=140;if(full_height- height_allowance<=max_height)return;$condensed.addClass('condensed-processed');$condensed.css('max-height',max_height);var txt=$condensed.attr("data-expand-text");if(!txt)txt="Read More...";var $expand=$("<div>",{class:"expand-condensed",html:txt});$expand.click(function(){$condensed.css("max-height","100%");$condensed.trigger('expanded');$(this).remove();});$condensed.after($expand);};ngutils.blackout=function(){this.remove_on_hide=false;this.loaded=false;this.visible=false;this.$elements={};this._onload=null;this._onload_context=this;this._onshow=null;this._onshow_context=this;this._onhide=null;this._onhide_context=this;this._onremove=null;this._onremove_context=this;this.$container=null;};ngutils.blackout.prototype={onLoad:function(callback,thisArg){this._onload=typeof(callback)=='function'?callback:null;this._onload_context=thisArg?thisArg:this;},onShow:function(callback,thisArg){this._onshow=typeof(callback)=='function'?callback:null;this._onshow_context=thisArg?thisArg:this;},onHide:function(callback,thisArg){this._onhide=typeof(callback)=='function'?callback:null;this._onhide_context=thisArg?thisArg:this;},onRemove:function(callback,thisArg){this._onremove=typeof(callback)=='function'?callback:null;this._onremove_context=thisArg?thisArg:this;},load:function(url,data,jQuery_success){var _this=this;this.loaded=false;$.get(url,data,function(data,textStatus,jqXHR){_this.loaded=true;_this.show(data);if(typeof(jQuery_success)=='function')jQuery_success.call(this,data,textStatus,jqXHR);if(_this._onload)_this._onload.call(_this._onload_context);});},show:function(data){var _this=this;var $body=$('body').first();if(data){if(!_this.$elements.hover){var $hover=$("<div>");$hover.addClass('blackout-hover');$body.append($hover);var $centered=$("<div>");$centered.addClass('blackout-center');$hover.append($centered);_this.$elements.hover=$hover;_this.$elements.centered=$centered;}
_this.$elements.centered.html(data);$('a[data-action="close"]',_this.$elements.hover).click(function(){_this.hide();});}
if(!this.$elements.blackout){var $blackout=$("<div>");$blackout.addClass('blackout');$blackout.click(function(e){_this.hide();});$body.append($blackout);_this.$elements.blackout=$blackout;}
for(var e in this.$elements){this.$elements[e].show();}
if(!this.visible&&this.$elements.centered){setTimeout(function(){var notify_height=$("#notification-bar").outerHeight();var hover_height=_this.$elements.centered.outerHeight();var window_height=$(window).height()- notify_height;var doc_height=$(document).height();var scrolltop=$body.scrollTop();var top=scrolltop+ notify_height
if(hover_height){if(window_height>hover_height){var diff=Math.floor((window_height- hover_height)/2);
if(diff>40)diff=40;top+=diff;}
if(top+ hover_height>doc_height){top-=(top+ hover_height)- doc_height;}
if(top<notify_height)top=notify_height;}
_this.$elements.hover.css('top',top);_this.visible=true;if(_this._onshow)_this._onshow.call(_this._onshow_context);},1);}else{this.visible=true;if(this._onshow)this._onshow.call(this._onshow_context);}},hide:function(){if(this.remove_on_hide)return this.remove();for(var e in this.$elements){this.$elements[e].hide();}
this.visible=false;if(this._onhide)this._onhide.call(this._onhide_context);},toggle:function(){if(this.visible)this.hide();else this.show();},remove:function(){for(var e in this.$elements){this.$elements[e].remove();}
this.$elements={};this.loaded=false;this.visible=false;if(this._onremove)this._onload.call(this._onremove_context);}};ngutils.blackout.prototype.constructor=ngutils.blackout;ngutils.notification_controller={containers:{},init:function(){var container=$('#notification_icons');this.notification_bar=$('#notification-bar');this.bar_color=this.notification_bar.css('backgroundColor');this.flash_color="#fc0";if(container){$("a[id^='notify']").each(function(){$(this).show();var info=$(this).attr('id').split("_");var mode=info.shift();var item=info.join("_");ngutils.notification_controller.containers[item]={toggles:(mode=='notifyonly'),element:$(this),value:0};});};var data=PHP.get("notification_init_values",null);if(data)ngutils.notification_controller.parse(data,false);setInterval(this.load,30000);},load:function(){$.getJSON(PHP.get("notification_ajax_url",'/checknotifications'),function(data){ngutils.notification_controller.parse(data,true);});},parse:function(data,animated){var changed=false;for(var item in data){if(this.update(item,data[item],animated))changed=true;}
if(animated&&changed&&this.bar_color&&this.flash_color){this.notification_bar.stop();this.notification_bar.css('backgroundColor',this.flash_color);this.notification_bar.animate({'backgroundColor':this.bar_color},1000);}},update:function(item,value){if(!this.containers[item])return;var element=this.containers[item].element;var toggles=this.containers[item].toggles;var oldval=this.containers[item].value;var span=$('span',element);this.containers[item].value=value;span.html(value?value:"");element.removeClass('disabled');if(!(toggles&&value))element.addClass('disabled');return value>oldval;}};$(function(){if(PHP.get('activeuser'))ngutils.notification_controller.init();ngutils.checkDataAttributes();});ngutils.checkDataAttributes=function(){$('*[data-exec-script]').click(function(){var handler=$(this).attr('data-exec-script');var params=$(this).attr('data-exec-params');try{if(params){var jsp=JSON.parse(params);}
params=jsp;}
catch(e){console.error('Bad JSON in data-exec-params="'+params+'"');return false;}
return ngutils.dataExecScript.execute(handler,params);});$('a[data-post-on-click]').each(function(){var params=$(this).attr('data-post-on-click');if(params.indexOf("{")!==0){params={};}else{try{var jsp=JSON.parse(params);params=jsp;}
catch(e){console.error('Bad JSON in data-post-on-click="'+params+'"');return false;}}
$(this).formifyLink(params);});};ngutils.dataExecScript={handlers:{ngutils:ngutils},addHandler:function(handler,alias){this.handlers[alias]=handler;},execute:function(alias,param_obj){var obj=null;var chain=alias.split(".");var a;var thisobj=window;function doError(a){console.error("data-exec-script='"+alias+"' refers to undefined or unregistered object at '"+a+"'.");}
while(chain.length>0){a=chain.shift();if(!obj){if(!this.handlers[a]){doError(a);return false;}
obj=this.handlers[a];}else{if(!obj[a]){doError(a);return false;}
obj=obj[a];}
if(chain.length>0)thisobj=obj;}
if(typeof(obj)!='function'){console.error("data-exec-script='"+alias+"' refers to "+typeof(obj)+". Must be a function.");}
if(!param_obj){return obj();}else if(Array.isArray(param_obj)){return obj.apply(thisobj,param_obj);}else{return obj(param_obj);}}};ngutils.friendship={};ngutils.friendship.remove=function(id,context){if(confirm("Are you sure you want to un-friend this user?"))return false;alert('too bad, this feature hasn\'t been coded yet!');return false;};ngutils.friendship.add=function(id,context){alert('too bad, this feature hasn\'t been coded yet!');return false;};ngutils.fave_follow=function(fave_type,selector,user_key,button_key){var _this=this;var $element=$(selector);var waiting=false;this.common=null;var $add_button=$("a[data-action='add']",$element);var $remove_button=$("a[data-action='remove']",$element);var $reaction_button=$(".reaction-button",$element);var $reaction_options=$(".reaction-options",$element);var $reaction_emote=$(".reaction-emote",$element);var $reaction_text=$(".reaction-text",$element);var reaction_options_visible=false;this.onRefresh=function(data,target){};function showReactionOptions(e){if(e)e.stopPropagation();$reaction_options.show();reaction_options_visible=true;if(_this.common&&_this.common.closeLinked)_this.common.closeLinked();return false;}
function hideReactionOptions(e){if(e)e.stopPropagation();$reaction_options.hide();reaction_options_visible=false;return false;}
this.hideReactionOptions=function(){hideReactionOptions();};$reaction_button.click(showReactionOptions);if(!is_mobile)$element.hover(showReactionOptions,hideReactionOptions);$add_button.click(function(e){e.stopPropagation();if(waiting)return false;var extra_id=parseInt($(this).attr('data-extra-id'));waiting=true;var ajax_url="/favorites/"+ngutils.fave_follow.types[fave_type]+"/add/"+button_key;if(typeof(extra_id)!='undefined')ajax_url+="/extra/"+extra_id;var data={fave_type:ngutils.fave_follow.types[fave_type],emote_text:$(this).attr('title'),emote_class:$('span',$(this)).first().attr('class')};ngutils.fave_follow.refreshListeners(button_key,true,extra_id,data,_this);var params={userkey:user_key};if(PHP.get('ng_design'))params['___ng_design']=PHP.get('ng_design');$.getJSON(ajax_url,params,function(data){waiting=false;ngutils.fave_follow.refreshListeners(button_key,true,extra_id,data,_this);ngutils.reactions.refreshListeners(data.count_key,data,_this);}).fail(function(){waiting=false;ngutils.fave_follow.refreshListeners(button_key,false,extra_id,data,_this);});hideReactionOptions();return false;});$remove_button.click(function(e){e.stopPropagation();if(waiting)return false;waiting=true;var ajax_url="/favorites/"+ngutils.fave_follow.types[fave_type]+"/remove/"+button_key;var data={fave_type:ngutils.fave_follow.types[fave_type],emote_text:"React",emote_class:$('span',$(this)).first().attr('class')};ngutils.fave_follow.refreshListeners(button_key,false,0,data,_this);var params={userkey:user_key};if(PHP.get('ng_design'))params['___ng_design']=PHP.get('ng_design');$.getJSON(ajax_url,params,function(data){waiting=false;ngutils.fave_follow.refreshListeners(button_key,false,0,data,_this);ngutils.reactions.refreshListeners(data.count_key,data,_this);}).fail(function(){waiting=false;});hideReactionOptions();return false;});this.refresh=function(active,extra_id,data,target){if(data.fave_type=='reaction'){$reaction_emote.attr('class','reaction-emote '+data.emote_class);$reaction_text.html(data.emote_text);if(!active)$reaction_text.removeClass('active');else $reaction_text.addClass('active');$('a.active',$reaction_options).removeClass('active');$('a[data-extra-id="'+extra_id+'"]',$element).addClass('active');}else{if(typeof(extra_id)=='undefined'){$element.removeAttr('data-extra-id');}else{$element.attr('data-extra-id',extra_id);}
if(active)$element.addClass('active');else $element.removeClass('active');}
this.onRefresh(data,target);}
ngutils.fave_follow.listeners[button_key]=ngutils.fave_follow.listeners[button_key]||[];ngutils.fave_follow.listeners[button_key].push(this);};ngutils.fave_follow.listeners={};ngutils.fave_follow.FOLLOW=1;ngutils.fave_follow.FAVORITE=2;ngutils.fave_follow.REACTION=3;ngutils.fave_follow.types={};ngutils.fave_follow.types[ngutils.fave_follow.FOLLOW]='follow';ngutils.fave_follow.types[ngutils.fave_follow.FAVORITE]='favorite';ngutils.fave_follow.types[ngutils.fave_follow.REACTION]='reaction';ngutils.fave_follow.refreshListeners=function(button_key,active,extra_id,data,target){if(ngutils.fave_follow.listeners[button_key]){for(var i=0,len=ngutils.fave_follow.listeners[button_key].length;i<len;i++){ngutils.fave_follow.listeners[button_key][i].refresh(active,extra_id,data,target);}}};ngutils.initFollowButton=function(selector,user_key,button_key){return new ngutils.fave_follow(ngutils.fave_follow.FOLLOW,selector,user_key,button_key);};ngutils.initFavoriteButton=function(selector,user_key,button_key){return new ngutils.fave_follow(ngutils.fave_follow.FAVORITE,selector,user_key,button_key);};ngutils.initReactionButton=function(selector,user_key,button_key,common_id){var ff=new ngutils.fave_follow(ngutils.fave_follow.REACTION,selector,user_key,button_key);ff.common=ngutils.initReactionLink(common_id,'button',ff);return ff;};ngutils.reactions={};ngutils.reactions.totals={};ngutils.reactions.linked=[];ngutils.initReactionLink=function(common_id,prop,val){if(!common_id)return null;if(!ngutils.reactions.linked[common_id])ngutils.reactions.linked[common_id]={};ngutils.reactions.linked[common_id][prop]=val;return ngutils.reactions.linked[common_id];}
ngutils.reactions.refreshListeners=function(key,data,target){if(ngutils.reactions.totals[key]&&ngutils.reactions.totals[key].length>0){for(var i=0;i<ngutils.reactions.totals[key].length;i++){var $total=ngutils.reactions.totals[key][i];$total.html(data.count_html);$total.closeDetails();}}}
ngutils.reactionBlackout=null;ngutils.initReactionTotals=function(selector,item_type,item_id,common_id){var key=item_type+"-"+ item_id;if(!ngutils.reactions.totals[key])ngutils.reactions.totals[key]=[];var $total=$(selector);var $total_hover=null;var common=ngutils.initReactionLink(common_id,'totals',$total);ngutils.reactions.totals[key].push($total);var showing=false;function hideTotals(e){if($total_hover)$total_hover.remove();$total_hover=null;if(e)e.stopPropagation();showing=false;$(window).off('resize',hideTotals);return false;}
common.closeLinked=$total.closeDetails=function(){hideTotals();}
$(window).resize(function(){hideTotals();});function showTotals(e){if(e)e.stopPropagation();if(showing)return false;if(common&&common.button)common.button.hideReactionOptions();var base_url="/favorites/reactions/type/"+item_type+"/id/"+item_id;$.get(base_url,function(data){if(!data){showing=false;return;}
$total_hover=$("<div>").addClass('hover-absolute');$total_hover.html(data);$total_hover.offset($total.offset());$('body').append($total_hover);$child=$("div",$total_hover).first();var left=$total.offset().left;var width=$total.outerWidth();var right=left+ width;var cspace=$(window).width()/ 3;
var cwidth=$child.width();var overflow=8;if(cwidth<width){$child.css('left',((width-cwidth)/2) - overflow);
}else if(left>cspace*2){$child.css('right',-(width+ overflow));}else if(right<cspace){$child.css('left',0);}else{var center=(cwidth- width)/ 2;
$child.css('left',-center);}
$close_x=$('.close-x',$child).click(hideTotals);ngutils.initReactionUsers(item_type,item_id,$child);});showing=true;return false;}
$total.click(function(e){if(showing)return hideTotals(e);return showTotals(e);});};ngutils.initReactionUsers=function(item_type,item_id,$child){var base_url="/favorites/reactions/type/"+item_type+"/id/"+item_id;if(!$child)$child=$('body').first();if(!ngutils.reactionBlackout)ngutils.reactionBlackout=new ngutils.blackout();$('[data-extra-id]',$child).click(function(e){if(e){e.preventDefault();e.stopPropagation();}
var extra_id=$(this).attr('data-extra-id');ngutils.reactionBlackout.onLoad(function(){var $hover;if($hover=ngutils.reactionBlackout.$elements.hover){setTimeout(function(){$('.pagenav a',ngutils.reactionBlackout.$elements.hover).click(function(){ngutils.reactionBlackout.load($(this).attr('href'));return false;});},5);}});ngutils.reactionBlackout.load(base_url+"/reaction/"+extra_id);return false;});}
ngutils.forms={};ngutils.forms.registerDateInput=function(input){var $input=$(input);if($input.attr('data-registered'))return;function onChange(){if($input.val()){$input.addClass('date-focused');}else{$input.removeClass('date-focused');}}
$input.attr('data-registered',1);$input.change(onChange);onChange();};ngutils.forms.selectLinks={};ngutils.forms.selectLinks.autodetect=function(){$('[data-select-links]').change(function(){var url=($(this).val());if(url){window.location=url;}});}
ngutils.forms.fakeSelect={};ngutils.forms.fakeSelect.autodetect=function(){$('.faux-select:not(.ready)').each(function(){$(this).addClass('ready');var select=$(this);var options=$('span.options',select);var bubble=true;ngutils.event.addListener(ngutils.event.closeall,function(){if(bubble)select.removeClass('expanded');bubble=true;});$('a',$(this)).click(function(){bubble=false;});$('ul',$(this)).click(function(){if(bubble)return false;});$(this).click(function(){if($(this).hasClass('expanded')){$(this).removeClass('expanded');}else{ngutils.event.dispatch(ngutils.event.closeall);$(this).addClass('expanded');options.outerWidth(select.outerWidth());}
if(bubble)return false;});$(window).scroll(function(){if(select.hasClass('expanded')){select.removeClass('expanded');}});});}
ngutils.media={};ngutils.media.smartscale=function($element){var dimensions=$element.attr('data-smart-scale').split(",");$element.removeAttr('data-smart-scale');var width=dimensions[0].indexOf("%")<0?parseInt(dimensions[0]):dimensions[0];var height=dimensions[1].indexOf("%")<0?parseInt(dimensions[1]):dimensions[1];var cw=null;var $closest=$element.parent();var parent_selectors=['.blog-embed-left','p','.pod-body'];var s,$p;for(s=0;s<parent_selectors.length;s++){$p=$element.closest(parent_selectors[s]);if($p&&$p.length>0){$closest=$p;break;}}
function setDimensions(){var pw=$closest.width();if(pw===cw)return;var nw=width;var nh=height;if(typeof(nw)=='number'&&pw<width){nw=pw;if(typeof(nh)=='number'){var scale=pw/width;nh=Math.round(height*scale);}}
if(nw==cw)return;var css_class='media-block-center';var css_inline={'width':nw,'height':nh}
if(!is_mobile&&pw>nw&&nw<pw/2)css_class='media-inline-auto';$element.removeClass('media-inline-auto');$element.removeClass('media-block-center');$element.addClass(css_class);$element.css(css_inline);cw=nw;}
if(is_mobile){$(window).resize(setDimensions);}
setDimensions();};ngutils.media.smartscale.autodetect=function(){$('[data-smart-scale]').each(function(){new ngutils.media.smartscale($(this));});}
ngutils.media.smartload=function($element){var self=this;var src=$element.attr('data-smartload-src');var loaded=false;var y_buffer=400;var $container=$element.closest("div[class^='condensed']");if(!$container||$container.length<1)$container=null;if($container){var cropped_at=$container.offset().top+ $container.innerHeight();if($element.offset().top<cropped_at)$container=null;}
$element.removeAttr('data-smartload-src');this.checkOnScreen=function(){if(loaded)return;if(!$container){var w_top=$(window).scrollTop();var w_bottom=w_top+ $(window).height();var e_top=$element.offset().top;var e_bottom=e_top+ $element.height();if((e_top- y_buffer<w_bottom)&&(e_bottom+ y_buffer>w_top))load();}}
function load(){$element.attr('src',src);$(document).off('scroll',self.checkOnScreen);$(window).off('resize',self.checkOnScreen);loaded=true;}
if($container){function onContainerExpand(){$container.off('expanded',onContainerExpand);$container=null;self.checkOnScreen();}
$container.on('expanded',onContainerExpand);}
$(document).on('scroll',self.checkOnScreen);$(window).on('resize',self.checkOnScreen);self.checkOnScreen();};ngutils.media.smartload.autodetect=function(){$('[data-smartload-src]').each(function(){new ngutils.media.smartload($(this));});};ngutils.media.item=function(id){this.id=id?id:null;this.sources={};};ngutils.media.item.prototype={qualities:[],addSource:function(src,type,quality){if(!quality)quality=this.qualities[0];if(this.qualities.indexOf(quality)<0)console.error("Invalid media quality: "+quality);if(!this.sources[quality])this.sources[quality]=[];this.sources[quality].push({src:src,type:type});},getAvailableQualities:function(){var qs=[];for(var i=0;i<this.qualities.length;i++){if(this.sources[this.qualities[i]])qs.push(this.qualities[i]);}
return qs;}}
ngutils.local={getItem:function(item,default_val){value=localStorage.getItem(item);if(value){value=JSON.parse(value);}
else if(default_val){value=default_val;}
else{value=null;}
return value;},setItem:function(item,value){var result=localStorage.setItem(item,JSON.stringify(value));return result;}};ngutils.media.audio=function(){ngutils.media.item.apply(this,arguments);this.qualities=['mp3'];this.type='audio';this.html="";var self=this;var base_url="/audio/load/";this.load=function(callback){var data={};if(PHP.get('ismobile'))data.isMobile=true;$.ajax({dataType:"json",url:base_url+ this.id,async:true,data:data,success:function(data){if(data.error){console.error(data.error);}else if(data.html&&data.sources){for(var i=0;i<data.sources.length;i++){self.addSource(data.sources[i].src,data.sources[i].type);}
self.html=data.html;if(typeof(callback)=='function')callback();}else{console.error("Unexpected Server Response from "+base_url+self.id,data);}}});}};ngutils.media.audio.prototype=Object.create(ngutils.media.item.prototype);ngutils.media.audio.prototype.constructor=ngutils.media.audio;Object.defineProperty(ngutils.media.audio,'volume',{get:function(){var vol=ngutils.local.getItem('ng-audio-vol',1);vol=parseFloat(vol);if(isNaN(vol))vol=1;return vol;},set:function(vol){vol=parseFloat(vol);if(isNaN(vol))vol=1;ngutils.local.setItem('ng-audio-vol',vol);}});ngutils.media.video=function(){ngutils.media.item.apply(this,arguments);this.qualities=['1080p','720p','360p'];this.type='video';};ngutils.media.video.prototype=Object.create(ngutils.media.item.prototype);ngutils.media.video.prototype.constructor=ngutils.media.video;ngutils.media.playlist=function(type){this._items=[];this._shuffled=[];this._shuffle=false;this._current_index=0;this.type=type;};ngutils.media.playlist.prototype={addMedia:function(title,callback){var source;switch(this.type){case'audio':source=new ngutils.media.video(title);break;case'video':source=new ngutils.media.audio(title);break;default:throw("Invalid media type: "+this.type);}
if(typeof(callback)=='function')callback(source);this.add(source);return this;},add:function(media_item){var i=this._items.length;this._items.push(media_item);},clear:function(){this._items=[];this._shuffled=[];this._shuffle=false;this._current_index=0;},_doshuffle:function(){this._shuffled=[];var j,x,i;for(i=0;i<this._items.length;i++){if(this._shuffled.length){x=Math.floor(Math.random()*this._shuffled.length);this._shuffled.splice(x,0,i);}else{this._shuffled.push(i);}}},toggleShuffle:function(){this.shuffle(!this._shuffle);if(this._shuffle)this._doshuffle();},shuffle:function(shuffle){if(typeof(shuffle)=='undefined')return this._shuffle;shuffle=shuffle?true:false;if(shuffle!=this._shuffle){this._current_index=0;this._shuffle=shuffle;if(this._shuffle)this._doshuffle();}
return this;},setCurrentItem:function(media){var bookmark=this._current_index;for(this._current_index=0;this._current_index<this._items.length;this._current_index++){if(this.getCurrentItem()==media){return true;}}
this._current_index=bookmark;return false;},getCurrentItem:function(){if(this._current_index<0||this._current_index>=this._items.length)return null;if(this._shuffle){return this._items[this._shuffled[this._current_index]];}
return this._items[this._current_index];},forward:function(can_loop){if(this._current_index>=0)this._current_index++;else this._current_index=0;if(this._current_index>=this._items.length){if(!can_loop){return null;}
this._current_index=0;}
return this.getCurrentItem();},reverse:function(can_loop){if(this._current_index<this._items.length)this._current_index--;else this._current_index=this._items.length-1;if(this._current_index<0){if(!can_loop){return null;}
this._current_index=this._items.length-1;}
return this.getCurrentItem();}};ngutils.media.getPlaylist=function(type){var playlist=new ngutils.media.playlist();playlist.type=type=='video'?'video':'audio';return playlist;}
ngutils.media.player=function($player_element,$controls_element,$display_element){this.wait_for_async=false;this.$player_element=null;this.$controls_element=null;this.$display_element=null;this.controls=null;this.type=null;this.autoplay=false;this._loop=false;this._shuffle=false;this.active=false;this.playing=false;this.paused=false;this.skip_forward_time=15;this.skip_back_time=15;this.media_playlist=null;this.current_media_item=null;this.quality="default";if(!$player_element)throw('Missing $player_element');if(typeof($player_element)=='string')$player_element=$("#"+$player_element);if(!$controls_element&&!$player_element.is('audio')){$controls_element=$player_element;$player_element=$('audio',$controls_element).first();}
if(!$display_element){$display_element=$('.media-player-display',$controls_element).first();}
this.onPressPlay=function(){};this.onPressStop=function(){};this.onPressPause=function(){};this.onPressSkipForward=function(){};this.onPressSkipBack=function(){};this.onPressPlayNext=function(){};this.onPressPlayPrevious=function(){};this.onPressLoop=function(){};this.onPressFullscreen=function(){};this.onPressShuffle=function(){};this.onTimeChange=function(newtime){};this.onVolumeChange=function(newvolume){};this.onPlaybackStarted=function(){};this.onPlaybackEnded=function(){};this.onLoopEnabled=function(){};this.onLoopDisabled=function(){};this.onShuffleEnabled=function(){};this.onShuffleDisabled=function(){};this.onMediaPaused=function(media){};this.onMediaUnpaused=function(media){};this.onMediaStarted=function(media){};this.onMediaEnded=function(media){};this.onMediaLoaded=function(media){};this.setCurrentTitle=function(){};this.registerAudioElement($player_element);if($controls_element)this.registerControls($controls_element);if($display_element)this.registerDisplay($display_element);};ngutils.media.player.prototype={activate:function(){this.active=true;this.$controls_element.addClass('active');},deactivate:function(){this.active=false;this.$controls_element.removeClass('active');},loop:function(loop){if(typeof(loop)=='undefined'){return this._loop;}
this._loop=loop?true:false;this._loop?this.onLoopEnabled():this.onLoopDisabled();this.updateControls();return this;},shuffle:function(shuffle){if(typeof(shuffle)=='undefined')return this._shuffle;this._shuffle=shuffle?true:false;this._shuffle?this.onShuffleEnabled():this.onShuffleDisabled();if(this.media_playlist)this.media_playlist.shuffle(this._shuffle);this.updateControls();return this;},endMedia:function(){if(this.playing||this.paused){this.onMediaEnded(this.current_media_item);}
this.playing=false;this.paused=false;},updateControls:function(){this.controls.play.removeClass('active');this.controls.pause.removeClass('active');this.controls.play_pause.removeClass('active');this.controls.play_pause.removeClass('paused');this.controls.shuffle.removeClass('active');this.controls.loop.removeClass('active');this.controls.fullscreen.removeClass('active');if(this.playing){this.controls.play.addClass('active');this.controls.play_pause.addClass('active');}else if(this.paused){this.controls.play_pause.addClass('active');this.controls.play_pause.addClass('paused');this.controls.pause.addClass('active');}
if(this.media_playlist){this.controls.play_next.show();this.controls.play_previous.show();this.controls.shuffle.show();}else{this.controls.play_next.hide();this.controls.play_previous.hide();this.controls.shuffle.hide();}
if(this.loop()){this.controls.loop.addClass('active');}
if(this.shuffle()){this.controls.shuffle.addClass('active');}
if(this.controls.position_bar)this.controls.position_bar.updateBarBounds();},setDisplay:function(html){if(this.$display_element)this.$display_element.html(html);},setStopped:function(){this.endMedia();if(this.active){this.onPlaybackEnded();}
this.deactivate();this.updateControls();},setPlaying:function(){if(!this.active){this.onPlaybackStarted();}
if(!this.playing&&this.paused){this.onMediaUnpaused(this.current_media_item);}else if(!this.playing){this.onMediaStarted(this.current_media_item);}
this.activate();this.playing=true;this.paused=false;this.updateControls();},setPaused:function(){if(this.playing&&!this.paused){this.onMediaPaused(this.current_media_item);}
this.playing=false;this.paused=true;this.updateControls();},setMedia:function(media_item){var $player=this.$player_element;var self=this;if(!$player||$player.length<1)return false;if(this.current_media_item==media_item)return false;this.initForAsynch(function(){media_item.load(function(){self.onMediaLoaded(media_item);self.doSetMedia(media_item);});});},initForAsynch:function(callback){var $player=this.$player_element;var self=this;if($('source',$player).length<1){var sources=[]
if($player.is('audio')){sources.push({src:PHP.get('www_root')+"/content/micro.mp3",type:"audio/mpeg"});}
if(sources.length>0){this.wait_for_async=true;this.setCurrentSources(sources);setTimeout(function(){self.wait_for_async=false;callback();},150);return;}}
callback();},setCurrentSources:function(sources){var $player=this.$player_element;$player.html("");var $source;for(i=0;i<sources.length;i++){$source=$("<source/>");$source.attr('src',sources[i].src);$source.attr('type',sources[i].type);$player.append($source);}
$player[0].pause();$player[0].load();$player[0].currentTime=0;},doSetMedia:function(media_item){this.current_media_item=media_item;var $player=this.$player_element;var i,q=null;var qa=media_item.getAvailableQualities();for(i=0;i<qa.length;i++){if(!q)q=qa[i];if(qa[i]==this.quality){q=qa[i];break;}}
var sources=media_item.sources[q];this.setCurrentSources(sources);this.setCurrentTitle(media_item.title);var self=this;if((!this.playing&&self.autoplay)||this.playing){setTimeout(function(){self.play();},150);}
return(sources.length>0);},setPlaylist:function(media_playlist){this.media_playlist=media_playlist;if(media_playlist){media_playlist.shuffle(this.shuffle());this.setMedia(media_playlist.getCurrentItem());}},canPlay:function(){var $player=this.$player_element;if(!$player||$player.length<1)return false;var canplay=false;$('source',$player).each(function(){var format=$(this).attr('type');var c=$player[0].canPlayType(format);if(c=='probably'||c=='maybe')canplay=c;});return canplay?canplay:false;},initVolume:function(){var volume=ngutils.media.audio.volume;this.$player_element[0].volume=volume;this.controls.volume_bar.setPosition(volume);},setVolume:function(volume){if(volume>1)volume=1;else if(volume<0)volume=0;this.$player_element[0].volume=volume;ngutils.media.audio.volume=volume;this.onVolumeChange(volume);},play:function(){if(!this.canPlay())return false;this.$player_element[0].play();this.setPlaying();return true;},pause:function(){if(!this.canPlay())return false;this.$player_element[0].pause();this.setPaused();return true;},stop:function(){if(!this.canPlay())return false;this.$player_element[0].pause();this.$player_element[0].currentTime=0;this.setStopped();return true;},skip_forward:function(){if(!this.canPlay())return false;var mt=this.$player_element[0].currentTime+ this.skip_forward_time;if(mt>this.$player_element[0].duration)mt=this.$player_element[0].duration;this.$player_element[0].currentTime=mt;return true;},skip_back:function(){if(!this.canPlay())return false;var mt=this.$player_element[0].currentTime- this.skip_back_time;if(mt<0)mt=0;this.$player_element[0].currentTime=mt;return true;},play_next:function(){var media=false;if(this.media_playlist){media=this.media_playlist.forward(this.loop());}
if(media){this.endMedia();this.current_media_item=null;this.setMedia(media);return media;}
this.stop();return false},play_previous:function(){var media=false;if(this.media_playlist){media=this.media_playlist.reverse(this.loop());}
if(media){this.endMedia();this.current_media_item=null;this.setMedia(media);return media;}
this.stop();return false},end:function(){this.setStopped();},getTimeFormat:function(s,ms_length){var seconds=s;if(isNaN(seconds))return[0,0,0,0];var hours=Math.floor(seconds/60/60);seconds-=hours*60*60;var minutes=Math.floor(seconds/60);seconds-=minutes*60;var format=[];if(hours>0){hours=""+hours;format.push(hours.length);format.push(2);format.push(2);return format;}else{format.push(0);}
if(minutes>=10){format.push(2);}else{format.push(1);}
format.push(2);format.push(ms_length?ms_length:0);return format;},formatTime:function(s,format){var seconds=s;if(isNaN(seconds))return"--:--:--";if(!format)format=this.getTimeFormat(seconds);var hours=Math.floor(seconds/60/60);seconds-=hours*60*60;var minutes=Math.floor(seconds/60);seconds-=minutes*60;seconds=Math.round(seconds*100);var ms=(seconds%100);seconds=((seconds- ms)/100);
time="";if(format[0]>0){hours=""+hours;while(hours.length<format[0]){hours="0"+hours;}
time=time+hours+":";}
if(format[1]>0){minutes=""+minutes;while(minutes.length<format[1]){minutes="0"+minutes;}
time=time+minutes+":";}
if(format[2]>0){seconds=""+seconds;while(seconds.length<format[2]){seconds="0"+seconds;}
time=time+seconds;}
if(format[3]>0){ms=""+ms;while(ms.length<format[3]){ms=ms+"0";}
time=time+"."+ms;}
return time?time:"--:--:--";},handleMediaEnded:function(){if(this.wait_for_async)return;if(this.media_playlist){this.play_next();}else if(this.loop()){this.play();}else{this.end();}},registerAudioElement:function($player_element){if(typeof($player_element)=='string')$player_element=$("#"+$player_element);if($player_element.is('audio')){this.type='audio';}else if($player_element.is('video')){this.type='video';}else{throw("Invalid $player_element");}
var self=this;$player_element.on('ended',function(){self.handleMediaEnded();});this.$player_element=$player_element;},refreshTime:function(){var ct=this.$player_element[0].currentTime;var d=this.$player_element[0].duration;var format=this.getTimeFormat(d);this.controls.current_time.html(this.formatTime(ct,format));this.controls.duration.html(this.formatTime(d,format));this.onTimeChange(ct);},toggleFullScreen:function(){var fs=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;var elem,req;if(fs){elem=document;req=elem.exitFullScreen||elem.webkitExitFullscreen||elem.mozCancelFullScreen;}else{elem=this.$controls_element[0];req=elem.requestFullScreen||elem.webkitRequestFullscreen||elem.mozRequestFullScreen;}
if(req)req.call(elem);},registerDisplay:function($display_element){if(typeof($display_element)=='string')$display_element=$("#"+$display_element);this.$display_element=$display_element;},registerControls:function($controls_element){if(typeof($controls_element)=='string')$controls_element=$("#"+$controls_element);this.$controls_element=$controls_element;if(this.controls){for(var i in this.controls){this.controls[i].off();}}
var controls={title:$(".media-player-title",$controls_element).first(),play:$(".media-player-play",$controls_element).first(),pause:$(".media-player-pause",$controls_element).first(),play_pause:$(".media-player-play-pause",$controls_element).first(),stop:$(".media-player-stop",$controls_element).first(),skip_forward:$(".media-player-skip-forward",$controls_element).first(),skip_back:$(".media-player-skip-back",$controls_element).first(),play_next:$(".media-player-play-next",$controls_element).first(),play_previous:$(".media-player-play-previous",$controls_element).first(),loop:$(".media-player-loop",$controls_element).first(),shuffle:$(".media-player-shuffle",$controls_element).first(),quality:$(".media-player-quality",$controls_element).first(),fullscreen:$(".media-player-fullscreen",$controls_element).first(),current_time:$(".media-player-current-time",$controls_element).first(),duration:$(".media-player-duration",$controls_element).first()}
var sbar,sbutton;sbar=$(".media-player-position-bar",$controls_element).first();sbutton=$(".media-player-position-button",$controls_element).first();if(sbar&&sbutton&&sbar.length>0&&sbutton.length>0){controls.position_bar=new ngutils.ui.slider({bar:sbar,button:sbutton,fill:$(".media-player-position-fill",$controls_element).first(),});}
sbar=$(".media-player-volume-bar",$controls_element).first();sbutton=$(".media-player-volume-button",$controls_element).first();if(sbar&&sbutton&&sbar.length>0&&sbutton.length>0){controls.volume_bar=new ngutils.ui.slider({direction:'up',bar:sbar,button:sbutton,fill:$(".media-player-volume-fill",$controls_element).first(),add:$(".media-player-volume-up",$controls_element).first(),subtract:$(".media-player-volume-down",$controls_element).first(),toggle:$(".media-player-volume-toggle",$controls_element).first(),select:$(".media-player-volume-select",$controls_element).first(),lock_bar:true});}
var $player=this.$player_element;var self=this;this.setCurrentTitle=function(title){controls.title.html(title);};controls.loop.click(function(){self.loop(!self._loop);self.onPressLoop();return false;});controls.shuffle.click(function(){self.shuffle(!self._shuffle);self.onPressShuffle();return false;});controls.play.click(function(){self.play();self.onPressPlay();return false;});controls.pause.click(function(){self.pause();self.onPressPause();return false;});controls.play_pause.click(function(){if(self.paused||!self.playing){self.play();self.onPressPlay();}else{self.pause();self.onPressPause();}
return false;});controls.stop.click(function(){self.stop();self.onPressStop();return false;});controls.skip_forward.click(function(){self.skip_forward();self.onPressSkipForward();return false;});controls.skip_back.click(function(){self.skip_back();self.onPressSkipBack();return false;});controls.play_next.click(function(){self.play_next();self.onPressPlayNext();return false;});controls.play_previous.click(function(){self.play_previous();self.onPressPlayPrevious();return false;});controls.fullscreen.click(function(){self.toggleFullScreen();self.onPressFullscreen();return false;});function onTimeUpdate(){var p=$player[0].currentTime/$player[0].duration;if(controls.position_bar)controls.position_bar.setPosition(p);self.refreshTime();}
$player.on('timeupdate',function(e){onTimeUpdate();});function setPlayPosition(p){if(!isNaN($player[0].duration))$player[0].currentTime=$player[0].duration*p;}
if(controls.position_bar){controls.position_bar.onStopDrag=function(p){setPlayPosition(p);}}
if(controls.volume_bar){controls.volume_bar.onPositionChanged=function(pos){self.setVolume(pos);}}
this.controls=controls;if(controls.volume_bar){self.initVolume();}}};ngutils.components={auto_id:0,nextAutoID:function(){this.auto_id++;return"ngutils-components-autoid-"+this.auto_id;},idFor:function($element){var id=$element.attr('id');if(!id){id=this.nextAutoID();$element.attr('id',id);}
return id;}};ngutils.components.audio={global_player:null,playback_items:{},playlists:{},current_playlist:null,registerPlaybackItem:function($playback_element){if(typeof($playback_element)=='string')$playback_element=$("#"+$playback_element);if($playback_element.attr('data-registered'))return this;var item=new ngutils.components.audio.playbackItem($playback_element);return this;},registerPlaylistWrapper:function($wrapper_element){if(typeof($wrapper_element)=='string')$wrapper_element=$("#"+$wrapper_element);if($wrapper_element.attr('data-registered'))return this;var list=new ngutils.components.audioList($wrapper_element);return this;},registerGlobalPlayer:function($audio_element,$control_element,$display_element){var self=this;var player=new ngutils.media.player($audio_element,$control_element,$display_element);player.autoplay=true;$('[data-audio-playback]').each(function(){self.registerPlaybackItem($(this));});if(!ngutils.components.audioList.global){$('[data-audio-playlist]').each(function(){self.registerPlaylistWrapper($(this));});}
function onMediaLoaded(media){player.setDisplay(media.html);}
function onStartMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.addClass('playing');media.playbackItem.$element.removeClass('paused');}}
function onEndMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.removeClass('playing');media.playbackItem.$element.removeClass('paused');}}
function onPauseMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.removeClass('playing');media.playbackItem.$element.addClass('paused');}}
function onUnpauseMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.addClass('playing');media.playbackItem.$element.removeClass('paused');}}
var $volumeControl=$('#global-audio-player-volume');var $volumeToggle=$('.media-player-volume-toggle a',$volumeControl).first();function onChangeVolume(volume){if($volumeControl&&$volumeControl.length>0){$volumeToggle.removeClass('fa-volume-up');$volumeToggle.removeClass('fa-volume-down');$volumeToggle.removeClass('fa-volume-off');if(volume>0.5){$volumeToggle.addClass('fa-volume-up');}else if(volume<=0){$volumeToggle.addClass('fa-volume-off');}else{$volumeToggle.addClass('fa-volume-down');}}}
player.onMediaLoaded=onMediaLoaded;player.onMediaStarted=onStartMedia;player.onMediaEnded=onEndMedia;player.onMediaPaused=onPauseMedia;player.onMediaUnpaused=onUnpauseMedia;player.onVolumeChange=onChangeVolume;onChangeVolume(ngutils.media.audio.volume);this.global_player=player;}}
ngutils.components.audio.playbackItem=function($playback_element){if(typeof($playback_element)=='string')$playback_element=$("#"+$playback_element);this.$element=$playback_element;this.$element.attr('data-registered',1);var audio_id=this.$element.attr('data-audio-playback');audio_id=parseInt(audio_id);if(!audio_id||isNaN(audio_id)){console.error("Invalid data-audio-playback value",this.$element.attr('data-audio-playback'));return;}
this.id=ngutils.components.idFor(this.$element);this.media=new ngutils.media.audio(audio_id);this.media.playbackItem=this;this.valid=true;var self=this;this.$element.show();this.$element.off('click');this.$element.click(function(){self.play();return false;});ngutils.components.audio.playback_items[this.id]=this;if(ngutils.components.audioList.global!==null){ngutils.components.audioList.global.addPlaybackItem(this);}};ngutils.components.audio.playbackItem.prototype={valid:false,media:null,id:null,getPlaylist:function(){var id=this.$element.attr('data-audio-playlist-id');return id?ngutils.components.audio.playlists[id]:null;},play:function(){var self=this;if(ngutils.components.audio.global_player.current_media_item==this.media){if(ngutils.components.audio.global_player.playing){ngutils.components.audio.global_player.pause();}else{ngutils.components.audio.global_player.play();}
return;}
var playlist=this.getPlaylist();if(playlist){playlist.setCurrentItem(this.media);playlist.play();}else{if(ngutils.components.audio.global_player){ngutils.components.audio.global_player.stop();ngutils.components.audio.global_player.setPlaylist(null);ngutils.components.audio.global_player.setMedia(this.media);}}}};ngutils.components.audioList=function($wrapper_element){var self=this;this.list=ngutils.media.getPlaylist('audio');if($wrapper_element!='global'){if(typeof($wrapper_element)=='string')$wrapper_element=$("#"+$wrapper_element);this.$element=$wrapper_element;this.$element.attr('data-registered',1);this.id=ngutils.components.idFor(this.$element);$("[data-audio-playback]",this.$element).each(function(){var media_id=$(this).attr('id');var item=ngutils.components.audio.playback_items[media_id];self.addPlaybackItem(item);});}else{this.id='ngutils.components.audioList.global';this.$element=null;}
ngutils.components.audio.playlists[this.id]=this;};ngutils.components.audioList.global=null;ngutils.components.audioList.enableGlobalPlaylist=function(enable){if(enable===false){ngutils.components.audioList.global=null;}else if(ngutils.components.audioList.global===null){ngutils.components.audioList.global=new ngutils.components.audioList('global');}};ngutils.components.audioList.clearGlobalPlaylist=function(){if(ngutils.components.audioList.global){ngutils.components.audio.global_player.stop();ngutils.components.audioList.global.clear();}}
ngutils.components.audioList.prototype={addPlaybackItem:function(item){if(item&&item.media){this.list.add(item.media);item.$element.attr('data-audio-playlist-id',this.id);}},setCurrentItem:function(media){if(!this.list){console.error("This playlist wrapper has not been registered.");}else{this.list.setCurrentItem(media);}
return this;},play:function(){if(ngutils.components.audio.global_player){ngutils.components.audio.global_player.stop();ngutils.components.audio.global_player.setPlaylist(this.list);}},clear:function(){this.list.clear();}};ngutils.ui={};ngutils.ui.slider=function(config){this._dragging=false;this.onStartDrag=function(position){}
this.onStopDrag=function(position){}
this.onPositionChanged=function(position){}
function missingRequired(bit){console.error("Could not initialize slider with missing/invalid '"+bit+"' value.");}
function getJquery(value){value=typeof(value)=='string'?$('#'+value):value;if(!value||!value instanceof jQuery||value.length<1)value=null;return value;}
this.$bar=getJquery(config.bar);this.$button=getJquery(config.button);if(!this.$bar)missingRequired('bar');if(!this.$button)missingRequired('button');this.$fill=getJquery(config.fill);this.$add=getJquery(config.add);this.$subtract=getJquery(config.subtract);this.$toggle=getJquery(config.toggle);this.$select=getJquery(config.select);this.$bar.css('position','relative');this.$button.css('position','absolute');if(this.$fill)this.$fill.css('position','absolute');this._position=parseFloat(config.position);var self=this;if(this.$add||this.$subtract){this._increment=parseFloat(config.increment);if(isNaN(this._increment)||!this._increment||this._increment<=0)this._increment=0.05;}
if(this.$add)this.$add.click(function(){self.setPosition(self._position+ self._increment);return false;});if(this.$subtract)this.$subtract.click(function(){self.setPosition(self._position- self._increment);return false;});var $document=$(document);if(this.$toggle&&this.$select){this.$toggle.on(ngutils.input.mouseUp,function(){self.updateBarBounds();self.$select.toggle();self.$toggle.blur();self.$select.focus();return false;});$document.on(ngutils.input.mouseUp,function(){self.$select.hide();});}
this._left=0;this._width=0;this._offset=0;this._lock_bar=config.lock_bar?true:false;var directions=['up','down','left','right'];if(config.direction){this._direction=typeof(config.direction)=='string'&&directions.indexOf(config.direction.toLowerCase())>=0?config.direction.toLowerCase():'right';}else{this._direction='right';}
if(this.$fill){switch(this._direction){case'up':this.$fill.css('bottom','0px');break;case'down':this.$fill.css('top','0px');break;case'left':this.$fill.css('right','0px');break;case'right':this.$fill.css('left','0px');break;}}
function getMousePosition(e){var mouse,bar,size,pos,input;input=ngutils.input.getMouse(e);if(self._direction=='down'||self._direction=='up'){mouse=input.y;start=self._top;size=self._height;}else{mouse=input.x;start=self._left;size=self._width;}
pos=mouse-(self._offset+ start);if(pos<0)pos=0;else if(pos>size)pos=size;pos=pos/size;if(self._direction=='up'||self._direction=='left')pos=1-pos;return pos;}
if(is_mobile){$(window).resize(function(){self.updateBarBounds();self.updateFill();self.updateButton();});}
this.updateBarBounds();this.updateFill();this.updateButton();function handleDrag(e){e.preventDefault();if(self._lock_bar){self.setPosition(getMousePosition(e));}else{self.updateButton(getMousePosition(e));}}
function startDrag(e){e.preventDefault();self._dragging=true;self.onStartDrag(self._position);handleDrag(e);$document.off(ngutils.input.mouseUp,endDrag);$document.on(ngutils.input.mouseUp,endDrag);$document.off(ngutils.input.mouseMove,handleDrag);$document.on(ngutils.input.mouseMove,handleDrag);self.$bar.blur();}
function endDrag(e){e.preventDefault();self._dragging=false;$document.off(ngutils.input.mouseMove,handleDrag);$document.off(ngutils.input.mouseUp,endDrag);self.setPosition(getMousePosition(e));self.onStopDrag(self._position);}
this.$bar.on(ngutils.input.mouseDown,function(e){startDrag(e);return false;});};ngutils.ui.slider.prototype={updateBarBounds:function(){var self=this;var toggle_select=(self.$select&&self.$select.is(':hidden'));if(toggle_select)self.$select.show();var button_width=self.$button.outerWidth();var button_height=self.$button.outerHeight();self._left=self.$bar.offset().left;self._top=self.$bar.offset().top;self._width=self.$bar.innerWidth()- button_width;self._height=self.$bar.innerHeight()- button_height;if(this._direction=='down'||this._direction=='up'){self._offset=Math.round(button_height/2);}else{self._offset=Math.round(button_width/2);}
if(toggle_select)self.$select.hide();},setPosition:function(position){position=parseFloat(position);if(isNaN(position)||position<0)position=0;else if(position>1)position=1;if(position!==this._position){this._position=position;if(!this._dragging||this._lock_bar){this.updateButton();}
this.updateFill();this.onPositionChanged(this._position);}},updateButton:function(position){if(typeof(position)=='undefined')position=this._position;var fix;if(this._direction=='down'||this._direction=='up'){position=Math.round((this._height*position)*10)/10;
fix=this._direction=='up'?'bottom':'top';}else{position=Math.round((this._width*position)*10)/10;
fix=this._direction=='left'?'right':'left';}
this.$button.css(fix,position);},updateFill:function(){if(this.$fill){var position;if(this._direction=='down'||this._direction=='up'){position=Math.round((this._height*this._position)*10)/10;
position+=this._offset;this.$fill.css('height',position);}else{position=Math.round((this._width*this._position)*10)/10;
position+=this._offset;this.$fill.css('width',position);}}}};ngutils.report_akismet_spam=function(selector){var _this=this;var that=selector;if(that.is('a')){that.on('click',function(){var href=that.attr('href');$.post(href,function(response){that.on('click',function(){return false;});that.html('Reported spam');console.log(response);});return false;});}};ngutils.tableOfContents=function($list_element,$content_element){if(typeof($list_element)=='string')$list_element=$('#'+$list_element);if(typeof($content_element)=='string')$content_element=$('#'+$content_element);if(!$list_element.attr('class')){$list_element.addClass('table-of-contents');}
$('h2, h3, h4',$content_element).each(function(){var $heading=$(this);var tag,indent=0;if($heading.is('h3')){indent=1;}else if($heading.is('h4')){indent=2;}
if(!$heading.attr('id')){tag="ngutils-toc-"+ ngutils.tableOfContents.getNextIndex();$heading.attr('id',tag);}else{tag=$heading.attr('id');}
var $a=$('<a>').attr('href',"#"+tag).text($heading.text());var $li=$("<li>");$li.addClass('indent-'+indent);$li.append($a);$list_element.append($li);});};ngutils.tableOfContents.last_index=0;ngutils.tableOfContents.getNextIndex=function(){ngutils.tableOfContents.last_index++;return ngutils.tableOfContents.last_index;};ngutils.clearSelection=function(){if(document.selection&&document.selection.empty){document.selection.empty();}else if(window.getSelection){var sel=window.getSelection();sel.removeAllRanges();}};ngutils.initScrollFixColumn=function(){var $column=$(".scrollfix-column").first();if(!$column||$column.length<1)return;var fixed=false;var $notification_bar=$('#notification-bar');var $shim=$("<div></div>");$shim.attr('class',$column.attr('class'));$shim.attr('id','scrollfix-shim');$shim.hide();$column.after($shim);var $body=$('body');var native_y=$column.offset().top;var fixed_y=$notification_bar.outerHeight();var native_position=$column.css('position');var fix_at=native_y- fixed_y;function fix(){fixed=true;$column.css('position','fixed');$column.css('top',fixed_y);$shim.width($column.outerWidth());$shim.height($column.outerHeight());$shim.show();}
function unfix(){fixed=false;$shim.hide();$column.css('position',native_position);}
function checkScrollFixPosition(){var pos=$body.scrollTop();var fixme=(pos>=fix_at);if(fixed&&!fixme)unfix();else if(!fixed&&fixme)fix();}
checkScrollFixPosition();$(document).scroll(checkScrollFixPosition);};ngutils.bytesToString=function(bytes){var sizeSymbols=["KB","MB","GB","TB","PB","EB"];if(bytes===0){return bytes+ sizeSymbols[0];}
var i=-1;do{bytes=bytes/1e3;i++;}while(bytes>999);return Math.max(bytes,.1).toFixed(1)+ sizeSymbols[i];};ngutils.uploadEvent=function(event,uploader,target,data){this.event=event;this.uploader=uploader;this.target=target;this.data=data;};ngutils.uploadEvent.onSubmit="ngutils.uploadEvent.onSubmit";ngutils.uploadEvent.onUpload="ngutils.uploadEvent.onUpload";ngutils.uploadEvent.onCancel="ngutils.uploadEvent.onCancel";ngutils.uploadEvent.onDeleted="ngutils.uploadEvent.onDeleted";ngutils.uploadEvent.onError="ngutils.uploadEvent.onError";ngutils.uploader=function(element_selector,endpoint,config){var _uploader=this;var webImageTypes=['gif','jpg','jpeg','png'];if(!config)config={};var debug=config.debug?true:false;var multi=typeof(config.multiple)=='undefined'?false:(config.multiple?true:false);var chunking=typeof(config.chunking)=='undefined'?true:(config.chunking?true:false);var chunkSize=config.chunkSize?config.chunkSize:5000000;var maxConnections=config.maxConnections?config.maxConnections:3;var allowedExtensions=config.allowedExtensions?config.allowedExtensions:webImageTypes;var template=config.template?config.template:"upload_template_default";var sizeLimit=config.sizeLimit?config.sizeLimit:2e+9;var redirectsEnabled=config.redirectsEnabled?config.redirectsEnabled:true;_uploader.onSelect=config.onSelect?config.onSelect:null;_uploader.onError=config.onError?config.onError:null;_uploader.onComplete=config.onComplete?config.onComplete:null;_uploader.onCancel=config.onCancel?config.onCancel:null;var liveUpdate=config.liveUpdate?config.liveUpdate:false;var $uploader=$(element_selector);this.id=config.id?config.id:$uploader.attr('id');var $droparea,$drop_area_text,$uploader_inner,$preview_img;function hideDroparea(){$droparea.hide();}
function showDroparea(){$droparea.show();}
var fuconfig={messages:{},maxConnections:maxConnections,template:template,element:$uploader[0],multiple:multi,text:{fileInputTitle:" "},request:{endpoint:endpoint},chunking:{enabled:chunking},callbacks:{onSubmit:function(id,name){var event=new ngutils.uploadEvent(ngutils.uploadEvent.onSubmit,_uploader,null,{id:id,name:name});ngutils.event.dispatch(event.event,event);if(typeof(_uploader.onSelect)=='function')return _uploader.onSelect.call(this,id,name);},onUpload:function(id,name){$(".qq-error",$(this.getItemByFileId(id))).first().text('');$uploader_inner.addClass('uploading');var params={userkey:PHP.get('uek','')};if(config.component&&config.component.path){params.component=config.component;}
this.setParams(params);var $file=$(this.getItemByFileId(id));this.setUuid(id,PHP.get('uuid_prefix','poop')+this.getUuid(id));console.log(this.getUuid(id));var ext=name.toLowerCase().split(".").pop();var image_types=['gif','jpg','jpeg','png','bmp','tif','tiff'];if(image_types.indexOf(ext)<0){$('span.ng-upload-thumbnail-selector',$file).first().addClass("icon-dumpfile-"+ext).removeClass("ng-upload-thumbnail-selector");}
if(!multi)hideDroparea();var event=new ngutils.uploadEvent(ngutils.uploadEvent.onUpload,_uploader,$file,{id:id,name:name});ngutils.event.dispatch(event.event,event);},onComplete:function(id,name,response){if(redirectsEnabled&&response.redirect){window.location.href=response.redirect;return false;}
$uploader_inner.removeClass('uploading');var $file=$(this.getItemByFileId(id));var parked_id;if(response.parked_id){$("input.ng-id-selector",$file).first().val(response.parked_id);parked_id=response.parked_id;}
if(response.parked_url){$("input.ng-url-selector",$file).first().val(response.parked_url);}
if(response.image_url){var extension=response.image_url.split(".").pop().toLowerCase();if(liveUpdate&&webImageTypes.indexOf(extension)>=0&&$preview_img.length>0){$preview_img.attr('src',response.image_url);if(response.image_width)$preview_img.attr('height',response.image_width);if(response.image_height)$preview_img.attr('width',response.image_height);}}
if(response.delete_url){var $delete_button=$(".ng-upload-delete-seletor",$file).first();$delete_button.show();$delete_button.click(function(){$delete_button.disable();var params=(config.component&&config.component.path)?{component:config.component}:{};params.userkey=PHP.get('uek','');$.post(response.delete_url,params,function(response){var event=new ngutils.uploadEvent(ngutils.uploadEvent.onDeleted,_uploader,$file,{id:id,name:name,response:response});ngutils.event.dispatch(event.event,event);$file.remove();});})}
if(!multi)showDroparea();var event=new ngutils.uploadEvent(ngutils.uploadEvent.onComplete,_uploader,$file,{id:id,name:name,response:response});ngutils.event.dispatch(event.event,event);if(typeof(_uploader.onComplete)=='function')_uploader.onComplete.call(this,id,name,response);},onCancel:function(id,name){$uploader_inner.removeClass('uploading');if(!multi)showDroparea();var $file=$(this.getItemByFileId(id));var event=new ngutils.uploadEvent(ngutils.uploadEvent.onCancel,_uploader,$file,{id:id,name:name});ngutils.event.dispatch(event.event,event);if(typeof(_uploader.onCancel)=='function')return _uploader.onCancel.call(this,id,name);},onError:function(id,name,errorMsg){var $file=$(this.getItemByFileId(id));$uploader_inner.removeClass('uploading');if(!multi)showDroparea();var $error=$(".qq-error",$(this.getItemByFileId(id))).first();if(typeof(_uploader.onError)=='function'){_uploader.onError.call(this,id,name,errorMsg);}else if($error.length>0){$error.text(errorMsg);}else{alert(errorMsg);}
var event=new ngutils.uploadEvent(ngutils.uploadEvent.onError,_uploader,$file,{id:id,name:name,errorMsg:errorMsg});ngutils.event.dispatch(event.event,event);}},validation:{sizeLimit:sizeLimit,allowedExtensions:allowedExtensions},autoUpload:true,debug:debug};if(chunking){fuconfig.chunking.concurrent={enabled:true};fuconfig.chunking.partSize=chunkSize;fuconfig.chunking.mandatory=false;fuconfig.chunking.success={endpoint:endpoint};}
var minImageWidth=typeof(config.minImageWidth)=='number'?config.minImageWidth:null;var maxImageWidth=typeof(config.maxImageWidth)=='number'?config.maxImageWidth:null;var minImageHeight=typeof(config.minImageHeight)=='number'?config.minImageHeight:null;var maxImageHeight=typeof(config.maxImageHeight)=='number'?config.maxImageHeight:null;if(minImageWidth!==null||maxImageWidth!==null||minImageHeight!==null||maxImageHeight!==null){fuconfig.validation.image={};if(minImageWidth!==null){fuconfig.validation.image.minWidth=minImageWidth;fuconfig.messages.minWidthImageError="Image must be at least "+minImageWidth+"px wide!";}
if(maxImageWidth!==null){fuconfig.validation.image.maxWidth=maxImageWidth;fuconfig.messages.maxWidthImageError="Image can not be wider than "+maxImageWidth+"px!";}
if(minImageHeight!==null){fuconfig.validation.image.minHeight=minImageHeight;fuconfig.messages.minHeightImageError="Image must be at least "+minImageHeight+"px tall!";}
if(maxImageHeight!==null){fuconfig.validation.image.maxHeight=maxImageHeight;fuconfig.messages.maxHeightImageError="Image can not be taller than "+maxImageHeight+"px!";}}
if(debug)console.log("Uploader config for '"+element_selector+"'",fuconfig);var fu=new qq.FineUploader(fuconfig);$droparea=$('.qq-upload-drop-area',$uploader).first();$drop_area_text=$('.drop-area-text',$uploader).first();$uploader_inner=$('.qq-uploader-selector',$uploader).first();$preview_img=$('.ng-preview-image',$uploader).first();if(typeof(config.dropAreaText)=='string')$drop_area_text.text(config.dropAreaText);var text;if(!config.fileTypesText){text=allowedExtensions&&allowedExtensions.length>0?"Allowed extensions: "+allowedExtensions.join(", "):"Files";text+=" up to "+ngutils.bytesToString(sizeLimit);}else{text=$.trim(config.fileTypesText);}
if(text){$('.ng-file-rules-text',$uploader).first().text(text);}else{$('.ng-file-rules-text',$uploader).hide();}};ngutils.croptool=function(config){var id=config.id;this.id=id;ngutils.croptool.ids[id]=this;var $body=$('body').first();var croptool=this;var $template=$('#'+id);var $ui=$('<div>');$body.append($ui);$ui.html($template.html());var $frame=$('[data-crop-frame]',$ui).first();var $image=$('[data-cropping-image]',$ui).first();var $save_btn=$('[data-btn-save]',$ui).first();var $cancel_btn=$('[data-btn-cancel]',$ui).first();var $save_txt=$('[data-saving-text]',$ui).first();var $slider_bar=$('[data-scale-slider-container]',$ui).first();var $slider=$('[data-scale-slider]',$ui).first();this.startSave=function(){saving=true;$save_btn.disable();$cancel_btn.disable();$save_txt.show();$slider_bar.hide();}
this.endSave=function(){saving=false;$save_btn.enable();$cancel_btn.enable();$save_txt.hide();$slider_bar.show();}
var width=config.width;var height=config.height;var imgLoader=new Image();var anchor,minscale,maxscale,scale,scalerange;var maxzoom=config.maxZoom?config.maxZoom:'auto';var saving=false;$ui.css('display','none');$image.css('position','absolute');this.reset=function(){anchor={x:0,y:0};minscale=1;maxscale=2;scale=1;scalerange=1;$image.removeAttr('src');$(imgLoader).removeAttr('src');$slider.slider('value',0);};this.onCancel=function(){};this.onSave=function(crop,frame){};this.hide=function(){$body.css('overflow','');$ui.css('display','none');ngutils.croptool.current=null;this.reset();};this.show=function(){if(ngutils.croptool.current)ngutils.croptool.current.hide();ngutils.croptool.current=this;$body.css('overflow','hidden');$ui.css('display','');};this.update=function(){var iw=imgLoader.width*scale;var ih=imgLoader.height*scale;var l=Math.round((width/2)-(anchor.x*scale));var t=Math.round((height/2)-(anchor.y*scale));$image.css('width',iw).css('height',ih).css('left',l).css('top',t);};this.newImage=function(){$image.attr('src',imgLoader.src);var wscale=width/imgLoader.width;var hscale=height/imgLoader.height;var _maxzoom=maxzoom;if(maxzoom==='auto'){var xz=(imgLoader.width/width);var yz=(imgLoader.height/height);_maxzoom=xz>yz?xz:yz;console.log('maxzoom',_maxzoom,maxzoom,xz,yz);}
minscale=wscale>hscale?wscale:hscale;maxscale=minscale*_maxzoom;scale=minscale;scalerange=maxscale- minscale;anchor.x=Math.floor(imgLoader.width/2);anchor.y=Math.floor(imgLoader.height/2);croptool.update();}
this.showImage=function(src){$image.removeAttr('src');$image.attr('src',imgLoader.src);imgLoader.src=src;croptool.show();}
this.onDragged=function(moved){anchor.x-=moved.x/scale;anchor.y-=moved.y/scale;this.checkAnchor();this.update();};this.checkAnchor=function(){var fh=(height/2)/ scale;
var fw=(width/2)/ scale;
if(anchor.y<fh)anchor.y=fh;else if(anchor.y>imgLoader.height- fh)anchor.y=imgLoader.height- fh;if(anchor.x<fw)anchor.x=fw;else if(anchor.x>imgLoader.width- fw)anchor.x=imgLoader.width- fw;}
$(imgLoader).on('load',this.newImage);var dragging=false;var mousePos={x:0,y:0};$slider.slider({value:0,min:0,max:1,step:0.001,slide:function(event,ui){scale=minscale+(scalerange*ui.value);croptool.checkAnchor();croptool.update()}});$cancel_btn.click(function(){croptool.hide();croptool.onCancel();});$save_btn.click(function(){croptool.startSave();var crop={};var fh=(height/2)/ scale;
var fw=(width/2)/ scale;
crop.top=Math.ceil(anchor.y- fh);crop.left=Math.ceil(anchor.x- fw);crop.width=Math.floor(fw*2);crop.height=Math.floor(fh*2);crop.right=crop.left+ crop.width;crop.bottom=crop.top+ crop.height;if(croptool.onSave(crop,{width:width,height:height})===true)croptool.hide();});$image.on(ngutils.input.mouseDown,function(e){dragging=true;var posObj=e.changedTouches?e.changedTouches[0]:e;mousePos={x:posObj.screenX,y:posObj.screenY};});$(document).on(ngutils.input.mouseUp,function(){dragging=false;}).on(ngutils.input.mouseMove,function(e){if(!dragging||saving)return;var posObj=e.changedTouches?e.changedTouches[0]:e;var newPos={x:posObj.screenX,y:posObj.screenY};if(mousePos){croptool.onDragged({x:newPos.x- mousePos.x,y:newPos.y- mousePos.y});}
mousePos=newPos;return false;});if(config.src){imgLoader.src=config.src;}
this.reset();};ngutils.croptool.current=null;ngutils.croptool.ids={};ngutils.croptool.get=function(id){return typeof(ngutils.croptool.ids[id])!='undefined'?ngutils.croptool.ids[id]:null;};ngutils.croptool.prototype.constructor=ngutils.croptool;ngutils.croppableImage=function(selector,config){this.onSaved=function(){};this.onCancel=function(){};this.parked_id=null;this.parked_url='';var image_crop=this;var image=new Image();var $container=$(selector);var $aimage=$('[data-image-frame]',$container).first();var $img=$('img',$aimage).first();var $spinner=$('[data-image-spinner]',$container).first();var $save_text=$('[data-saving-text]',$container).first();var $upload=$('div[data-image-upload]',$container).first();var $upload_container=$('div[data-image-upload-toggle]',$container).first();var parkEndpoint=config.parkEndpoint?config.parkEndpoint:"/parkfile";var saveEndpoint=config.saveEndpoint?config.saveEndpoint:null;var saveParams=config.saveParams?config.saveParams:null;var fileTypesText=config.fileTypesText?config.fileTypesText:null;var dropAreaText=config.dropAreaText?config.dropAreaText:"Drop Image, or Click Here";var canEdit=$upload.length>0;var $crop_ui=$('[data-crop-ui]',$container).first();if(canEdit){$crop_ui.remove();$crop_ui.css('position','absolute').css('z-index','10002').css('top',100).hide();$('body').append($crop_ui);}
var $slider_container=$('[data-scale-slider-container]',$crop_ui).first();if(canEdit){var uconfig={template:"croppable_image_template",fileTypesText:fileTypesText,dropAreaText:dropAreaText,multiple:false,allowedExtensions:["png","jpeg","jpg","gif"],onComplete:function(id,filename,response){$(this.getItemByFileId(id)).remove();image_crop.parked_id=response.parked_id;image_crop.parked_url=response.parked_url;image_crop.newImage(image_crop.parked_url);}};if(config.sizeLimit)uconfig.sizeLimit=config.sizeLimit;if(config.maxWidth)uconfig.maxImageWidth=config.maxWidth;if(config.maxHeight)uconfig.maxImageHeight=config.maxHeight;if(config.minWidth)uconfig.minImageWidth=config.minWidth;if(config.minHeight)uconfig.minImageHeight=config.minHeight;if(config.debug)uconfig.debug=true;var uploader=new ngutils.uploader($upload,parkEndpoint,uconfig);}
this.dragMove=null;function updateSrc(src){$spinner.show();image.src=src;}
var mode='view';var dragging=false;mousePos=null;if(canEdit){$aimage.on(ngutils.input.mouseDown,function(e){dragging=mode!=='view'?true:false;var posObj=e.changedTouches?e.changedTouches[0]:e;mousePos={x:posObj.screenX,y:posObj.screenY};});$(document).on(ngutils.input.mouseUp,function(){dragging=false;}).on(ngutils.input.mouseMove,function(e){if(!dragging||saving)return;var posObj=e.changedTouches?e.changedTouches[0]:e;var newPos={x:posObj.screenX,y:posObj.screenY};if(mousePos){image_crop.onDragged({x:newPos.x- mousePos.x,y:newPos.y- mousePos.y});}
mousePos=newPos;return false;});}
this.src=config.src?config.src:null;this.oldSrc=this.src;if(!config.frame){config.frame={};}else{if(config.frame.width)config.frame.maxWidth=config.frame.minWidth=config.frame.width;if(config.frame.height)config.frame.maxHeight=config.frame.minHeight=config.frame.height;}
this.maxFrameWidth=config.frame.maxWidth?config.frame.maxWidth:1080;this.maxFrameHeight=config.frame.maxHeight?config.frame.maxHeight:360;this.minFrameWidth=config.frame.minWidth?config.frame.minWidth:480;this.minFrameHeight=config.frame.minHeight?config.frame.minHeight:240;this.fillScale=config.fillScale?config.fillScale:1;this.keepAspect=config.frame.keepAspect?config.frame.keepAspect:false;this.updateHeight=function(){if(image_crop.keepAspect){var cWidth=$aimage.width();var cHeight=$aimage.height();var aspectScale=cWidth/image_crop.maxFrameWidth;cHeight=Math.floor(image_crop.maxFrameHeight*aspectScale);$aimage.height(cHeight);}};if(this.keepAspect){this.minFrameWidth=this.maxFrameWidth;this.minFrameHeight=this.maxFrameHeight;this.updateHeight();}
this.minScale=1;this.maxScale=2;this.anchor={x:0,y:0};var frame={width:this.maxFrameWidth,height:Math.ceil(this.maxFrameHeight/(this.minFrameWidth/this.maxFrameWidth))};var $save=$('[data-btn-save]',$crop_ui).first();var $cancel=$('[data-btn-cancel]',$crop_ui).first();var saving=false;function startSaving(){saving=true;$cancel.disable();$save.disable();$slider_container.hide();$save_text.show();}
function endSaving(){saving=false;$cancel.enable();$save.enable();$slider_container.show();$save_text.hide();}
endSaving();if(canEdit){$cancel.click(function(){image_crop.cancelEdit();});$save.click(function(){startSaving();var output={crop:image_crop.crop,frame:frame,params:saveParams,parked_id:image_crop.parked_id}
$.post(saveEndpoint,output,function(result){image_crop.oldSrc=result.img_url;image_crop.clearEdit();image_crop.onSaved(result);},'json').fail(function(){endSaving();});});}
var nb_autohide=NiGhtBox.autohide;this.cancelEdit=function(){image_crop.clearEdit();image_crop.onCancel();}
this.clearEdit=function(){$crop_ui.hide();endSaving();mode='view';$container.removeClass('img-edit');$container.removeClass('nodim');NiGhtBox.autohide=nb_autohide;NiGhtBox.onClosed=null;NiGhtBox.hide();$upload_container.addClass('can-upload');updateSrc(image_crop.oldSrc);};this.newImage=function(url){mode='new';updateSrc(url);$container.addClass('img-edit');NiGhtBox.autohide=false;NiGhtBox.onClosed=function(){image_crop.cancelEdit();image_crop.onCancel();return false;}
var rando=Math.random();var $slider=$('[data-scale-slider]',$crop_ui).first();$slider.slider({value:0,min:0,max:1,step:0.001,slide:function(event,ui){image_crop.fillScale=image_crop.minScale+((image_crop.maxScale- image_crop.minScale)*ui.value);image_crop.draw();}});$crop_ui.show();NiGhtBox.show($container);$upload_container.removeClass('can-upload');};this.onDragged=function(dragged){this.dragMove=dragged;this.draw();};this.crop=null;this.draw=function(){$spinner.hide();if(!image.src||!image.width)return;if($img.attr('src')!==image.src)$img.attr('src',image.src);$img.css("width","");$img.css("height","");$img.css('top',"");$img.css('left',"");if(image_crop.keepAspect){image_crop.updateHeight();}
$crop_ui.css('top',$container.offset().top+ $container.height()).css('left',$container.offset().left).css('width',$container.width());var cWidth=$aimage.width();var cHeight=$aimage.height();if(mode==='view'){$img.css("width","100%");var bleed=Math.floor((cHeight- $img.height())/ 2);
$img.css('top',bleed+'px');}else{var iWidth=image.width;var iHeight=image.height;var iScale=cWidth/image_crop.maxFrameWidth;function drawMe(){var scale=iScale*image_crop.fillScale;var sWidth=iWidth*scale;var sHeight=iHeight*scale;if(image_crop.dragMove){image_crop.anchor.x-=Math.round(image_crop.dragMove.x/scale);image_crop.anchor.y-=Math.round(image_crop.dragMove.y/scale);image_crop.dragMove=null;}
var scaleFrame={width:Math.ceil(frame.width*iScale),height:Math.ceil(frame.height*iScale)}
var frameSpace={w:scaleFrame.width/2,h:scaleFrame.height/2,x:(scaleFrame.width- sWidth)/ 2,
y:(scaleFrame.height- sHeight)/ 2
}
var anchor={x:image_crop.anchor.x*scale,y:image_crop.anchor.y*scale};if(anchor.x<frameSpace.w){anchor.x=frameSpace.w;image_crop.anchor.x=anchor.x/scale;}else if(anchor.x>sWidth- frameSpace.w){anchor.x=sWidth- frameSpace.w;image_crop.anchor.x=anchor.x/scale;}
if(anchor.y<frameSpace.h){anchor.y=frameSpace.h;image_crop.anchor.y=anchor.y/scale;}else if(anchor.y>sHeight- frameSpace.h){anchor.y=sHeight- frameSpace.h;image_crop.anchor.y=anchor.y/scale;}
image_crop.crop={left:Math.round(image_crop.anchor.x-(frameSpace.w/scale)),right:Math.round(image_crop.anchor.x+(frameSpace.w/scale)),top:Math.round(image_crop.anchor.y-(frameSpace.h/scale)),bottom:Math.round(image_crop.anchor.y+(frameSpace.h/scale))}
image_crop.crop.width=image_crop.crop.right- image_crop.crop.left;image_crop.crop.height=image_crop.crop.bottom- image_crop.crop.top;var bleed={x:Math.round((cWidth/2)- anchor.x),y:Math.round((cHeight/2)- anchor.y)}
$img.css("width",Math.ceil(sWidth)+"px");$img.css("height",Math.ceil(sHeight)+"px");$img.css("left",bleed.x+"px");$img.css("top",bleed.y+"px");}
if(mode==='edit'){drawMe();}else if(mode=='new'){var wscale,hscale;wscale=frame.width/iWidth;hscale=frame.height/iHeight;image_crop.minScale=wscale>hscale?wscale:hscale;image_crop.maxScale=image_crop.minScale*2;if(image_crop.maxScale<1)image_crop.maxScale=1;image_crop.fillScale=image_crop.minScale;image_crop.anchor={x:Math.floor(iWidth/2),y:Math.floor(iHeight/2)};mode='edit';drawMe();}}}
$(image).on('load',this.draw);$(function(){image_crop.draw();});if(this.src)updateSrc(this.src);ngutils.event.addListener(ngutils.event.resize,function(){setTimeout(image_crop.draw,5);});}})(jQuery);}